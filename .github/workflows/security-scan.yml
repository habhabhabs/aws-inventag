name: Essential Security Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run security scans weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  security-scan:
    name: Essential Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'website/package-lock.json'

    - name: Python security analysis
      shell: bash
      run: |
        echo "ðŸ Python Security Analysis"
        echo "==========================="
        
        mkdir -p security-results
        
        # Install minimal security tools
        pip install bandit safety pip-audit
        
        if [ -f "requirements.txt" ]; then
          echo "ðŸ”’ Running Python security checks..."
          
          # Bandit for code security issues
          bandit -r scripts/ inventag/ -f json -o security-results/bandit.json || echo "âš ï¸ Bandit found potential issues"
          bandit -r scripts/ inventag/ || echo "âš ï¸ Review Bandit findings"
          
          # Safety for known vulnerabilities
          safety check -r requirements.txt || echo "âš ï¸ Some dependencies may have known vulnerabilities"
          
          # pip-audit for comprehensive dependency checking
          pip-audit --desc || echo "âš ï¸ Some dependencies may need updates"
        else
          echo "â„¹ï¸ No requirements.txt found, skipping Python dependency checks"
        fi

    - name: JavaScript/Node.js security analysis  
      shell: bash
      run: |
        echo "ðŸŸ¨ JavaScript/Node.js Security Analysis"
        echo "======================================="
        
        if [ -f "website/package.json" ]; then
          echo "ðŸ“¦ Checking Node.js dependencies..."
          cd website
          
          # Install dependencies
          npm install --silent || echo "âš ï¸ npm install had issues"
          
          # Run npm audit (built-in security check)
          npm audit || echo "âš ï¸ Some Node.js dependencies may have vulnerabilities"
          
          # Save audit results
          npm audit --json > ../security-results/npm-audit.json 2>/dev/null || echo "npm audit completed"
          
          cd ..
        else
          echo "â„¹ï¸ No website/package.json found, skipping Node.js checks"
        fi

    - name: Configuration and secrets scanning
      shell: bash
      run: |
        echo "ðŸ” Configuration and Secrets Analysis"
        echo "===================================="
        
        # Install minimal secrets detection
        pip install detect-secrets
        
        echo "ðŸ•µï¸ Running secrets detection..."
        detect-secrets scan --all-files --baseline security-results/secrets.baseline --force-use-all-plugins || echo "âš ï¸ Potential secrets detected"
        
        if [ -f "security-results/secrets.baseline" ]; then
          echo "âœ… Secrets baseline created"
        fi
        
        echo "ðŸ” Checking for sensitive file patterns..."
        find . -type f \( \
          -name "*.key" -o \
          -name "*.pem" -o \
          -name "*.env" -o \
          -name ".env.*" \
        \) -not -path "./website/node_modules/*" -not -path "./.git/*" | head -10 || echo "âœ… No obvious sensitive files found"

    - name: GitHub Actions security check
      shell: bash
      run: |
        echo "âš™ï¸ GitHub Actions Security Check"
        echo "==============================="
        
        find .github/workflows -name "*.yml" -o -name "*.yaml" | while read workflow; do
          echo "ðŸ” Checking workflow: $workflow"
          
          # Check for unpinned actions (security risk)
          if grep -E "uses:.*@(main|master|latest)" "$workflow"; then
            echo "âš ï¸ Found unpinned actions in $workflow (security risk)"
          else
            echo "âœ… Actions properly pinned in $workflow"
          fi
        done

    - name: Generate security summary
      shell: bash
      run: |
        echo "ðŸ“Š Generating Security Summary"
        echo "============================="
        
        # Count issues from various sources
        BANDIT_ISSUES=0
        NPM_ISSUES=0
        SECRETS_ISSUES=0
        
        if [ -f "security-results/bandit.json" ]; then
          BANDIT_ISSUES=$(jq '.results | length' security-results/bandit.json 2>/dev/null || echo "0")
        fi
        
        if [ -f "security-results/npm-audit.json" ]; then
          NPM_ISSUES=$(jq '.metadata.vulnerabilities.total' security-results/npm-audit.json 2>/dev/null || echo "0")
        fi
        
        if [ -f "security-results/secrets.baseline" ]; then
          SECRETS_ISSUES=$(jq '. | length' security-results/secrets.baseline 2>/dev/null || echo "0")
        fi
        
        TOTAL_ISSUES=$((BANDIT_ISSUES + NPM_ISSUES + SECRETS_ISSUES))
        
        echo "# Security Summary" > security-results/summary.md
        echo "" >> security-results/summary.md
        echo "**Date**: $(date)" >> security-results/summary.md
        echo "**Repository**: ${{ github.repository }}" >> security-results/summary.md
        echo "**Branch**: ${{ github.ref_name }}" >> security-results/summary.md
        echo "" >> security-results/summary.md
        echo "## Results" >> security-results/summary.md
        echo "- Bandit (Python) issues: $BANDIT_ISSUES" >> security-results/summary.md
        echo "- npm audit issues: $NPM_ISSUES" >> security-results/summary.md
        echo "- Potential secrets: $SECRETS_ISSUES" >> security-results/summary.md
        echo "- **Total findings**: $TOTAL_ISSUES" >> security-results/summary.md
        echo "" >> security-results/summary.md
        
        # Add recommendations
        if [ "$TOTAL_ISSUES" -gt 10 ]; then
          echo "ðŸš¨ **High Priority**: Multiple security issues detected" >> security-results/summary.md
        elif [ "$TOTAL_ISSUES" -gt 0 ]; then
          echo "âš ï¸ **Review Needed**: Some security findings require attention" >> security-results/summary.md
        else
          echo "âœ… **Good**: No major security issues detected" >> security-results/summary.md
        fi
        
        echo "" >> security-results/summary.md
        echo "## Tools Used" >> security-results/summary.md
        echo "- **Bandit**: Python code security scanner" >> security-results/summary.md
        echo "- **Safety**: Python dependency vulnerability checker" >> security-results/summary.md
        echo "- **pip-audit**: Advanced Python dependency auditing" >> security-results/summary.md
        echo "- **npm audit**: Node.js dependency vulnerability scanner" >> security-results/summary.md
        echo "- **detect-secrets**: Secrets detection across files" >> security-results/summary.md
        
        # GitHub Actions summary
        echo "## ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Python Issues**: $BANDIT_ISSUES" >> $GITHUB_STEP_SUMMARY
        echo "- **Node.js Issues**: $NPM_ISSUES" >> $GITHUB_STEP_SUMMARY
        echo "- **Secrets Issues**: $SECRETS_ISSUES" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Issues**: $TOTAL_ISSUES" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "$TOTAL_ISSUES" -gt 10 ]; then
          echo "ðŸš¨ **High Priority**: Review security findings immediately" >> $GITHUB_STEP_SUMMARY
        elif [ "$TOTAL_ISSUES" -gt 0 ]; then
          echo "âš ï¸ **Action Recommended**: Some security issues found" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **All Clear**: No major security issues detected" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload security results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-scan-results
        path: security-results/
        retention-days: 30